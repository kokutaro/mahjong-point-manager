# 麻雀点数計算・点棒管理アプリ

## 1. プロジェクト概要

オンライン対応の麻雀点数計算および点棒管理アプリケーションです。4人のプレイヤーがリアルタイムで対局を行い、点数計算と点棒の移動を自動化します。

### 1.1. セッション統一管理システム

**重要**: 本アプリケーションでは、単発対局・連続対局の区別なく、すべての対局を「セッション」として統一管理しています。

- **単発対局**: 1局のみのセッション
- **連続対局**: 複数局からなるセッション
- **継続判定**: 対局終了後、全員の合意により次局を継続
- **統一フロー**: すべての対局が同一のセッション管理フローで実行

## 2. 実装済み機能

### 2.1. セッション管理機能

- ✅ **セッション作成**: すべての対局はセッション単位で管理
- ✅ **継続判定システム**: 対局終了後の全員合意による次局継続
- ✅ **席順再設定**: 継続時の席順カスタマイズ機能
- ✅ **セッション内統計**: リアルタイムでの各局精算履歴表示
- ✅ **統一データフロー**: 単発/連続の区別なく同一処理フロー

### 2.2. 基本機能

- ✅ **オンライン対戦**: 4人のプレイヤーがリアルタイムで参加可能
- ✅ **ルーム作成・参加**: ルームコードによる対局参加システム
- ✅ **点数計算**: ツモ・ロンボタンから翻数・符数を選択し、親子判定で自動点数計算
- ✅ **点棒管理**: 計算した点数に基づく自動点数加減算
- ✅ **親ローテーション**: 連荘・親移動の自動管理（起家は席順0番固定）
- ✅ **連チャン管理**: 親のアガリ・流局時の本場増加と本場支払い計算
- ✅ **リーチ機能**: リーチ宣言とリーチ棒の管理
- ✅ **流局処理**: テンパイ・ノーテン判定による点数移動と供託管理

### 2.3. ゲーム設定機能

- ✅ **ゲーム種別**: 東風戦・半荘戦対応
- ✅ **配給原点設定**: 25,000点（固定）
- ✅ **返し点設定**: ゲーム開始時に20,000〜50,000点で設定可能
- ✅ **ウマ設定**: プリセット（ゴットー/ワンツー/ワンスリー）+ カスタム設定
- ✅ **トビ終了**: 有効・無効の設定可能
- ✅ **席順カスタマイズ**: プレイヤーの席順を自由に変更可能

### 2.4. UI/UX機能

- ✅ **レスポンシブデザイン**: スマートフォン・タブレット・PC対応
- ✅ **リアルタイム点数表示**: 各プレイヤーの現在点数をリアルタイム更新
- ✅ **直感的な操作**: ツモ・ロンボタン、翻数・符数選択UI
- ✅ **プレイヤー状態表示**: 順位、風牌、接続状態、リーチ状態の表示
- ✅ **ゲーム進行表示**: 現在局、本場、供託の表示

### 2.5. 対局終了・履歴機能

- ✅ **リザルト画面**: 最終点数・順位・精算結果の表示
- ✅ **継続選択**: 全員合意による「もう1局」継続システム
- ✅ **精算計算**: ウマを含めた最終精算（オカは廃止）
- ✅ **セッション履歴**: セッション単位での結果表示・統計
- ✅ **セッション内統計**: 各局の精算履歴とプレイヤー統計
- ✅ **CSVエクスポート**: 対局データのエクスポート機能

### 2.6. ゲーム明確終了機能

- ✅ **Phase 1: ホスト権限強化**: ホスト表示機能と強制終了API権限チェック（実装完了）
- ✅ **Phase 2: ホスト専用強制終了**: 結果画面でのホスト専用強制終了ボタン（実装完了）
- ✅ **Phase 3: 全員合意終了**: 継続/終了/保留の3択投票システム（実装完了）

**解決済み**: 対局終了後「ホームに戻る」した際、セッションが「継続可能なセッション」として残り続ける問題
**解決内容**: ホスト強制終了と全員合意終了の2つの明確な終了手段を提供し、すべてのセッション終了パターンに対応

#### 2.6.1. Phase 1 実装済み内容

- ホスト識別バッジ表示（👑 ホスト）
- 強制終了API権限チェック（ホストのみ実行可能）
- セキュリティ脆弱性の解消

#### 2.6.2. Phase 2 実装済み内容

- ホスト専用強制終了ボタン（確認ダイアログ付き）
- ForceEndConfirmModal コンポーネント（理由選択・バリデーション機能）
- WebSocket通知システム（終了理由と実行者の通知）
- レスポンシブデザイン対応
- 誤操作防止機能（2段階確認）
- 包括的テスト実装（13テストケース）

#### 2.6.3. Phase 3 実装済み内容

- 3択投票システム（継続/終了/保留）の完全実装
- 全員合意による民主的セッション終了機能
- VotingProgress コンポーネント（リアルタイム投票状況表示）
- 投票分析ロジック（analyzeVotes）による自動判定
- 投票API（POST/DELETE）とWebSocket投票通知システム
- 投票タイムアウト機能（5分間制限）とキャンセル機能
- 包括的テスト実装（25テストケース、100%パス）

### 2.7. 特殊ルール対応

- ✅ **ウマ（順位点）**: カスタマイズ可能な順位点
- ✅ **トビ終了**: マイナス点数での即時終了
- ❌ **焼き鳥**: 未実装（将来拡張予定）

## 3. 技術スタック

### 3.1. フロントエンド

- **Next.js 14** (App Router)
- **TypeScript** - 型安全性
- **Tailwind CSS** - スタイリング
- **Zustand** - 状態管理
- **Socket.IO Client** - リアルタイム通信

### 3.2. バックエンド

- **Next.js API Routes** - サーバーサイドAPI
- **Socket.IO** - WebSocketによるリアルタイム通信
- **Prisma ORM** - データベースアクセス
- **PostgreSQL** - データベース
- **Node.js** - サーバーランタイム

### 3.3. 開発・テスト環境

- **Jest + Testing Library** - テストフレームワーク
- **Docker Compose** - 開発環境構築
- **ESLint** - コード品質管理
- **TypeScript** - 型チェック

### 3.4. デプロイ・インフラ

- **Vercel** - フロントエンド・API デプロイ（予定）
- **Docker** - コンテナ化
- **PostgreSQL** - 本番データベース

## 4. 点数計算仕様

### 4.1. 基本計算

- 標準的な麻雀ルールに準拠
- 親・子の判定による点数差
- 翻数・符数からの自動計算
- ツモ・ロンの点数分配
- データベースによる点数パターン管理

### 4.2. 本場による加算

- **ツモ時**: 全員が本場×100点の追加支払い
- **ロン時**: ロンされたプレイヤーが本場×300点の追加支払い
- 本場は和了者が受け取り

### 4.3. 供託（リーチ棒・本場棒）

- リーチ宣言時に1,000点の供託
- 和了時に供託をすべて和了者が獲得
- 流局時は供託を持ち越し

## 5. ゲーム進行管理

### 5.1. 親番・本場管理

- **親のアガリ時**: 本場数を増加（連荘継続）
- **親のテンパイ流局**: 本場数を増加（親継続）
- **親のノーテン流局**: 本場数を増加（親継続）
- **子のアガリ時**: 本場数をリセット（親移動）

### 5.2. ゲーム終了条件

- **東風戦**: 東4局終了後
- **半荘戦**: 南4局終了後
- **トビ終了**: 任意プレイヤーの点数が0点以下（設定により有効/無効）

### 5.3. 流局処理

- テンパイ・ノーテン判定による点数移動
- ノーテン罰符: 3,000点をテンパイ者で分配
- リーチ状態の自動解除

## 6. 精算システム

### 6.1. 返し点システム

- 配給原点: 25,000点（固定）
- 返し点: ゲーム開始時に設定可能（20,000〜50,000点）
- 精算は返し点との差分で計算

### 6.2. ウマ計算

- プリセット対応:
  - ゴットー: [+1, +0.5, -0.5, -1]
  - ワンツー: [+2, +1, -1, -2]
  - ワンスリー: [+3, +1, -1, -3]
- カスタム設定可能

## 7. セッション管理フロー

### 7.1. セッション開始

- 対局開始前に必ずセッション作成
- プレイヤー選択と初期席順設定
- ゲーム設定（東風戦/半荘戦、ウマ等）

### 7.2. 対局実行

- セッション内での通常対局進行
- リアルタイム点数管理

### 7.3. 対局終了後の継続判定

```text
対局終了 → 結果画面 → 継続選択
    ↓         ↓         ↓
全員が「もう1局」押下？
    ↓         ↓
   YES       NO
    ↓         ↓
席順調整   セッション終了
    ↓
 次局開始
```

### 7.4. セッション内統計表示

- 対局中メニューから「セッション履歴」表示
- 各局の精算点数とプレイヤー統計をモーダル表示

## 8. プロジェクト構成

```text
src/
├── app/                   # Next.js App Router
│   ├── api/               # API Routes
│   │   ├── auth/          # 認証関連
│   │   ├── game/          # ゲーム操作
│   │   ├── room/          # ルーム管理
│   │   ├── score/         # 点数計算
│   │   ├── sessions/      # セッション管理
│   ├── game/              # ゲーム画面
│   ├── room/              # ルーム作成・参加
│   ├── sessions/          # セッション履歴
├── components/            # React コンポーネント
├── hooks/                 # カスタムフック
├── lib/                   # ユーティリティ・ロジック
│   ├── point-manager.ts   # 点数管理クラス
│   ├── score.ts           # 点数計算ロジック
│   └── socket.ts          # Socket.IO 設定
└── types/                 # TypeScript 型定義
```

## 9. テスト

### 9.1. テストカバレッジ

- **Unit Tests**: 点数計算ロジック、点数管理クラス、ユーティリティ関数
- **Integration Tests**: API エンドポイント（ルーム作成・参加、ゲーム操作）
- **Component Tests**: React コンポーネント（ゲーム画面、結果表示）
- **総テスト数**: 40+テスト（全パス）

### 9.2. 主要テスト項目

- 点数計算の正確性（親子、翻数・符数、ツモ・ロン）
- 精算計算（返し点、ウマ計算）
- 親番ローテーション・本場管理
- リーチ・供託システム
- 流局処理
- API エンドポイントの動作
- UI コンポーネントの表示・操作

### 9.3. テストコマンド

```bash
npm test              # テスト実行
npm run test:watch    # ウォッチモード
npm run test:coverage # カバレッジ測定
```

## 10. 開発・デプロイ

### 10.1. 開発環境構築

```bash
# 依存関係インストール
npm install

# データベース準備
npm run db:reset

# 開発サーバー起動
npm run dev
```

### 10.2. 本番デプロイ

```bash
# ビルド
npm run build

# 本番起動
npm start
```

## 11. セッション統一実装方針

### 11.1. データ設計統一

- **すべての対局がセッションに属する**: `sessionId`が必須
- **単発対局**: `games.length = 1`のセッション
- **連続対局**: `games.length > 1`のセッション
- **後方互換性**: 既存データをマイグレーションで対応

### 11.2. UI/UX統一設計

- **継続判定**: 結果画面で全員の「もう1局」合意を確認
- **席順調整**: 継続時は`/room/[roomCode]`で席順再設定
- **セッション統計**: ゲーム中メニューからモーダル表示
- **履歴分離**: セッション履歴と単発履歴を別画面で管理

### 11.3. 技術実装アプローチ

- **段階的移行**: 既存ロジックを活用しながら段階的にセッション化
- **統一フロー**: 単発/連続の条件分岐を排除
- **リアルタイム対応**: Socket.IOによるセッション状態同期

## 12. 詳細設計

より詳細な設計については `/docs/` 以下を参照してください：

- [アーキテクチャ設計](docs/architecture.md)
- [API設計](docs/api.md)
- [セッション管理システム](docs/session-management.md)
- [点数計算システム](docs/score-calculation.md)
- [点数管理システム](docs/point-management.md)
- [ゲーム精算システム](docs/game-settlement.md)
- [局管理システム](docs/round-management.md)
- [リーチ・供託システム](docs/reach-kyotaku.md)
- [オンライン対戦システム](docs/online-match.md)
- [UI/UX設計](docs/ui-ux-design.md)
- [ゲーム明確終了機能 Phase 1](docs/game-termination-phase1.md)
- [ゲーム明確終了機能 Phase 2](docs/game-termination-phase2.md)
